<html>
<head>
<style>
.selected {
	background-color: orange
}
button{
	width:100px;
	padding:5px 5px;
	border:1px solid black;
	-moz-border-radius: 10px;
	-webkit-border-radius: 10px;
	border-radius: 10px;
	font-size:1.1rem;
	background-color:white;
}
#regionList {
	width:200px;
	min-height:30px;
	background-color:rgba(200,200,200,0.5);
	border:thin solid lightGrey;
	position:relative;
}
#regionPicker {
	width:200px;
	position:absolute;
	top:50%;
	left:-230px;
	margin-top:-40px;
	border:thin solid black;
	background-color:white;
	padding:5px;
}
#decoration {
	position:absolute;
	left:210px;
	top:0;
	margin-top:20px;
}
.region-tag {
	position: relative;
}
.region-name {
	font-family: sans-serif;
	font-size:1.1rem;
}
.region-color {
	width:1.5rem;
	height:1.5rem;
	border:thin solid grey;
	display:inline-block;
	vertical-align:middle;
}
</style>
</head>
<body>

<div id="info" style="width:205px;padding:5px;border:thin solid black;background-color:rgba(200,200,200,0.5);position:absolute;top:5px;right:5px;z-index:100">
	<button id="zoom">zoom</button>
	<button id="select">select</button>
	<button id="draw">draw</button>
	<button id="delete">delete</button>
	<button id="addpoint">+point</button>
	<button id="delpoint">-point</button>
	<button id="addregion">+region</button>
	<button id="delregion">-region</button>
	<br/>
	Region
	<div id="regionList"></div>
</div>

<div id="regionPicker">
	<svg id="decoration">
		<polygon style="fill:white;stroke:none" points="-5,40 0,40 20,20 0,0 -5,0" />
		<polyline style="fill:none;stroke:black" points="0,40 20,20 0,0" />
	</svg>
</div>

<div id="openseadragon1" style="width:100%;"></div>

<script src="lib/paper-full.min.js"></script>
<script src="lib/openseadragon/openseadragon.min.js"></script>
<script src="lib/OpenSeadragonScalebar/openseadragon-scalebar.min.js"></script>
<script src="lib/jquery-1.11.0.min.js"></script>

<script>
var Ontology=[{name:"Telencephalon",parts:[
					{name:"Neocortex"},
					{name:"Rhinencephalon"},
					{name:"Amygdala"},
					{name:"Hippocampus"},
					{name:"Basal Ganglia"}
				 ]},
				 {name:"Diencephalon",parts:[
					{name:"Thalamus"},
					{name:"Hypothalamus"},
					{name:"Epithalamus"},
					{name:"Subthalamus"},
					{name:"Pituitary Gland"},
					{name:"Pineal Gland"}
				 ]},
				 {name:"Mesencephalon",parts:[
					{name:"Tectum"},
					{name:"Pretectum"},
					{name:"Cerebral Peduncle"}
				 ]},
				 {name:"Rhombencephalon",parts:[
					{name:"Pons"},
					{name:"Cerebellum"},
					{name:"Medulla Oblongata"}
				]}];
</script>

<script>
var Regions=[]; // list of regions: path, name, id, url, colour;
var region=null;
var tool;
var handle;
var newRegionFlag;
var selectedTool="zoom";
var viewer;

var counter=1;

var magic=0.163;
var magicW=1;
var magicH=2.2;

function mouseDown(event) {
	var zoom =viewer.viewport.viewportToImageZoom(viewer.viewport.getZoom(true));
	var point=event.point.multiply(magic/zoom);
	var prevRegion=null;
	
	switch(selectedTool) {
		case "select":
		case "addpoint":
		case "delpoint":
		case "addregion":
		case "delregion":
			for(i in Regions) {
				var re=Regions[i];
				handle = null;
				newRegionFlag=false;
				var hitResult = re.path.hitTest(point, {
					tolerance:5,
					stroke: true,
					segments:true,
					fill: true,
					handles:true
				});
				if (hitResult) {
					// select path
					if(region && region!=re) {
						region.path.selected=false;
						prevRegion=region;
					}
					re.path.fullySelected=true;
					region=re;
					$("#region-name").html(region.name);
			
					if (hitResult.type == 'handle-in') {
						handle = hitResult.segment.handleIn;
					} else
					if (hitResult.type == 'handle-out') {
						handle = hitResult.segment.handleOut;
					} else
					if (hitResult.type=='segment') {
						if(selectedTool=="select")
							handle=hitResult.segment.point;
						if(selectedTool=="delpoint")
							hitResult.segment.remove();
					} else
					if (hitResult.type=='stroke' && selectedTool=="addpoint") {
						region.path
						.curves[hitResult.location.index]
						.divide(hitResult.location);
						region.path.fullySelected=true;
						paper.view.draw();
					} else
					if (selectedTool=="addregion") {
						if(prevRegion) {
							var newPath=region.path.unite(prevRegion.path);
							Regions.splice(Regions.indexOf(prevRegion),1);
							prevRegion.path.remove();
							region.path.remove();
							region.path=newPath;
						}
					} else
					if (selectedTool=="delregion") {
						if(prevRegion) {
							var newPath=region.path.divide(prevRegion.path);
							Regions.splice(Regions.indexOf(prevRegion),1);
							prevRegion.path.remove();
							region.path.remove();
							region.path=newPath;
						}
					}

					break;
				}
			}
			if(hitResult==null && region) {
				// deselect paths
				region.path.selected=false;
				region=null;
			}
			break;
		case "draw":
			// Start a new region
			// if there was an older region selected, unselect it
			if(region)
				region.path.selected = false;
			// make a new region
			region=new Object();
			region.name="Untitled "+counter;
			counter+=1;
			var color=hashColor(region.name);
			region.path = new paper.Path({
				segments: [point],
				strokeColor: 'white',
				fillColor: 'rgba('+color.red+','+color.green+','+color.blue+',0.2)',
				selected: false
			});
			// display region information
			var el=$(regionTag(region.name));
			$("#regionList").append(el);
			el.click(function(){
				var name=$(this).text();
				regionPicker(this);
			});
			// push the new region to the Regions array
			Regions.push(region);
			// signal that a new region has been created
			newRegionFlag=true;
			break;
	}
}
function mouseDrag(event) {
	var zoom =viewer.viewport.viewportToImageZoom(viewer.viewport.getZoom(true));
	var point=event.point.multiply(magic/zoom);
	if (handle) {
		handle.x += event.delta.x*magic/zoom;
		handle.y += event.delta.y*magic/zoom;
	} else
	if(selectedTool=="draw") {
		region.path.add(point);
		paper.view.draw();
	}
}
function mouseUp(event) {
	if(newRegionFlag==true){
		region.path.simplify(10);
		region.path.closed=true;
		region.path.fullySelected = true;
	}
}
function newTool() {
	tool=new paper.Tool();
	tool.onMouseDown = mouseDown;
	tool.onMouseDrag= mouseDrag;
	tool.onMouseUp= mouseUp;
}
function selectTool() {
	$("button").removeClass("selected");
	$("button#"+selectedTool).addClass("selected");
}

$("button").click(function() {
	var prevTool=selectedTool;
	selectedTool=$(this).attr("id");
	selectTool();
	
	switch(selectedTool) {
		case "select":
		case "addregion":
		case "delregion":
		case "addpoint":
		case "delpoint":
		case "draw":
			viewer.setMouseNavEnabled(false);
			newTool();
			break;
		case "zoom":
			viewer.setMouseNavEnabled(true);
			tool.remove();
			handle=null;
			break;
		case "delete":
			for(i in Regions) {
				if(Regions[i].path.selected) {
					Regions[i].path.remove();
					Regions.splice(i,1);
					paper.view.draw();
					break;
				}
			}
			// go back to previous tool
			setTimeout(function() {
			selectedTool=prevTool;
			selectTool()},250);
			break;
	}
});

viewer = OpenSeadragon({
	id: "openseadragon1",
	prefixUrl: "lib/openseadragon/images/",
	mouseNavEnabled:true,
	tileSources: ["img/ISH_image562_nissl_series121129675.dzi"]
});
viewer.addHandler('open',function() {
	var width=1000*magicW;//viewer.source.width;
	var height=1000*magicH;//viewer.source.height;
	$("body").append("<canvas class='overlay' style='border:thin solid red'></canvas>");
	$("canvas.overlay").attr("width",width);
	$("canvas.overlay").attr("height",height);
	console.log(width,height);
	var	canvas=$("canvas.overlay")[0];
	canvas.className="overlay";
   	paper.setup(canvas);

	viewer.addOverlay({
		element:canvas,
		//location:viewer.viewport.imageToViewportRectangle(new OpenSeadragon.Rect(0, 0, width, height))
		location: new OpenSeadragon.Rect(0,0,magicW,magicH)
	});
});

function hashColor(name) {
	var color={};
	var hash=name.split("").reduce(function(a,b){
		a=((a<<5)-a)+b.charCodeAt(0);return a&a
	},0);
	color.red=hash&0xff;
	color.green=(hash&0xff00)>>8;
	color.blue=(hash&0xff0000)>>16;
	return color;
}
function regionTag(name) {
	var color=hashColor(name);
	var str=[	"<div class='region-tag' style='padding:2px'>",
				"<div class='region-color'",
				"style='background-color:rgba(",
				color.red,",",color.green,",",color.blue,",0.67",
				")'></div>",
				"<span class='region-name'>"+name+"</span>",
				"</div>",
				].join(" ");
	return str;
}
function appendRegionTagsFromOntology(o) {
	for(var i=0;i<o.length;i++) {
		if(o[i].parts) {
			$("#regionPicker").append("<div>"+o[i].name+"</div>");
			appendRegionTagsFromOntology(o[i].parts);
		}
		else {
			$("#regionPicker").append(regionTag(o[i].name));
		}
	}
}
function regionPicker(parent) {
	$("div#regionPicker").appendTo($(parent));
	$("div#regionPicker").show();
}

function changeRegionToRegion(oldName,newName) {
	var i;
	var color=hashColor(newName);
	var reg;
	for(i=0;i<Regions.length;i++) {
		if(Regions[i].name==oldName) {
			Regions[i].name=newName;
			Regions[i].path.fillColor='rgba('+color.red+','+color.green+','+color.blue+',0.2)';
			paper.view.draw();
			
			reg=$("#regionList > .region-tag").filter(function(){
				return $(this).find(".region-name").first().text()==oldName;
			});
			reg.find(".region-name").first().text(newName);
			reg.find(".region-color").first().css('background-color','rgba('+color.red+','+color.green+','+color.blue+',0.67)');
		}
	}
}

appendRegionTagsFromOntology(Ontology);


$(".region-tag").click(function(event){
	$("div#regionPicker").hide();
	var newName=$(this).find(".region-name").text();
	var oldName=$(this).parent().parent().find(".region-name").first().text();
	event.stopPropagation();
	changeRegionToRegion(oldName,newName);
});

selectTool();

</script>
</body>
</html>


